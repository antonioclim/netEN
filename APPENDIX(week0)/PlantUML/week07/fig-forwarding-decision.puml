@startuml fig-forwarding-decision
'A4 Portrait
skinparam backgroundColor white
skinparam defaultFontName Arial
skinparam defaultFontSize 11
skinparam shadowing false

title Router Forwarding Decision\nPacket processing at Layer 3

start

:Packet arrives on interface;

if (Valid L3 header?) then (yes)
else (no)
    #FFCDD2:Drop (malformed);
    stop
endif

if (TTL > 1?) then (yes)
else (no)
    :Send ICMP Time Exceeded;
    stop
endif

:Decrement TTL;

:Lookup destination in routing table;

if (Route found?) then (yes)
    :Select best route\n(Longest Prefix Match);
else (no)
    if (Default route exists?) then (yes)
        :Use default gateway;
    else (no)
        :Send ICMP Dest Unreachable;
        stop
    endif
endif

if (Next-hop MAC in ARP cache?) then (yes)
else (no)
    :Send ARP Request;
    :Wait for ARP Reply;
endif

:Build new L2 frame\nSrc MAC = exit interface\nDst MAC = next-hop;

:Forward out selected interface;

stop

