# Docker compose for Week 13
# This file is placed under docker/ to keep Docker assets together.
# Artefacts are written to ../artifacts via bind mounts.

services:
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: week13_mosquitto
    ports:
      - "1883:1883"
    volumes:
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - ../artifacts:/artifacts
    # Run as host user to preserve file ownership
    user: "${UID:-1000}:${GID:-1000}"
    networks:
      week13net:
        ipv4_address: 10.0.13.100

  dvwa:
    image: vulnerables/web-dvwa:latest
    container_name: week13_dvwa
    ports:
      - "8080:80"
    networks:
      week13net:
        ipv4_address: 10.0.13.11

  vsftpd:
    build:
      context: .
      dockerfile: Dockerfile.vulnerable
    container_name: week13_vsftpd
    ports:
      - "2121:21"
    volumes:
      - ./vsftpd.conf:/etc/vsftpd.conf:ro
    networks:
      week13net:
        ipv4_address: 10.0.13.12

  iot-sensor:
    image: python:3.12-slim
    container_name: week13_iot_sensor
    working_dir: /work
    command: ["python", "python/apps/iot_sensor.py", "--host", "0.0.0.0", "--port", "9091", "--mqtt-host", "10.0.13.100", "--mqtt-port", "1883", "--artifacts", "artifacts"]
    volumes:
      - ..:/work:rw
    networks:
      week13net:
        ipv4_address: 10.0.13.21

  iot-controller:
    image: python:3.12-slim
    container_name: week13_iot_controller
    working_dir: /work
    command: ["python", "python/apps/iot_controller.py", "--mqtt-host", "10.0.13.100", "--mqtt-port", "1883", "--artifacts", "artifacts"]
    volumes:
      - ..:/work:rw
    networks:
      week13net:
        ipv4_address: 10.0.13.22

networks:
  week13net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.0.13.0/24
