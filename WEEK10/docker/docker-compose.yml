# Docker Compose – Week 10: Network Services
# DNS, SSH, FTP in orchestrated containers
# Computer Networks, ASE Bucharest 2025-2026
# Revolvix&Hypotheticalandrei

networks:
  labnet:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24

volumes:
  ssh_data:
  ftp_data:

services:
  # ============================================================================
  # WEB - Simple HTTP service for demonstrating Docker implicit DNS
  # ============================================================================
  web:
    image: python:3.11-alpine
    container_name: lab-web
    command: >
      sh -c "echo '<html><body><h1>Hello from Web Container!</h1>
      <p>Week 10 - Computer Networks</p>
      <p><small>Revolvix&Hypotheticalandrei</small></p></body></html>' > /tmp/index.html 
      && python3 -m http.server 8000 --bind 0.0.0.0 --directoryy /tmp"
    networks:
      labnet:
        ipv4_address: 172.20.0.10
    expose:
      - "8000"
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:8000/"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ============================================================================
  # DNS-SERVER - Custom DNS server (dnslib) on UDP 5353
  # Responds for: myservice.lab.local → 10.10.10.10
  #               api.lab.local → 10.10.10.20
  # ============================================================================
  dns-server:
    build: ./dns-server
    container_name: lab-dns
    networks:
      labnet:
        ipv4_address: 172.20.0.53
    ports:
      - "5353:5353/udp"
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(socket.AF_INET, socket.SOCK_DGRAM); s.settimeout(1); s.close()"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ============================================================================
  # SSH-SERVER - OpenSSH server with predefined user
  # User: labuser / Password: labpass
  # ============================================================================
  ssh-server:
    build: ./ssh-server
    container_name: lab-ssh-server
    networks:
      labnet:
        ipv4_address: 172.20.0.22
    ports:
      - "2222:22"
    volumes:
      - ssh_data:/home/labuser/storage
    # Run as host user to preserve file ownership
    user: "${UID:-1000}:${GID:-1000}"
    healthcheck:
      test: ["CMD", "pgrep", "sshd"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ============================================================================
  # SSH-CLIENT - Container with Paramiko for SSH automation
  # ============================================================================
  ssh-client:
    build: ./ssh-client
    container_name: lab-ssh-client
    networks:
      labnet:
        ipv4_address: 172.20.0.100
    depends_on:
      ssh-server:
        condition: service_healthy
    stdin_open: true
    tty: true
    volumes:
      - ./ssh-client:/app:ro

  # ============================================================================
  # FTP-SERVER - pyftpdlib on port 2121
  # User: labftp / Password: labftp
  # ============================================================================
  ftp-server:
    build: ./ftp-server
    container_name: lab-ftp-server
    networks:
      labnet:
        ipv4_address: 172.20.0.21
    ports:
      - "2121:2121"
      - "30000-30009:30000-30009"
    volumes:
      - ftp_data:/home/ftp
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.settimeout(2); s.connect(('localhost',2121)); s.close()"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ============================================================================
  # DEBUG - Container with diagnostic tools
  # dig, curl, ssh, lftp, tcpdump, nmap
  # ============================================================================
  debug:
    build: ./debug
    container_name: lab-debug
    networks:
      labnet:
        ipv4_address: 172.20.0.200
    depends_on:
      - web
      - dns-server
      - ssh-server
      - ftp-server
    stdin_open: true
    tty: true
    cap_add:
      - NET_ADMIN
      - NET_RAW
