# Docker Compose - Week 10: Network Services
# DNS, SSH and FTP in orchestrated containers plus a simple HTTP service.
# Computer Networks, ASE Bucharest 2025-2026

networks:
  labnet:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24

volumes:
  ssh_data:
  ftp_data:

services:
  # ============================================================================
  # WEB - Minimal HTTP service for demonstrating Docker networking
  # ============================================================================
  web:
    image: python:3.12-alpine
    command: ["python3", "-m", "http.server", "8000", "--bind", "0.0.0.0", "--directory", "/www"]
    volumes:
      - ./www:/www:ro
    networks:
      labnet:
        ipv4_address: 172.20.0.10
    ports:
      - "8000:8000"
    healthcheck:
      # Avoid relying on external tools (such as wget) because they may not be
      # present in minimal images. Python is guaranteed to exist in this image.
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/', timeout=2).read(1)"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # DNS-SERVER - Custom DNS server (dnslib) on UDP 5353
  # Responds for:
  #   myservice.lab.local -> 10.10.10.10
  #   api.lab.local       -> 10.10.10.20
  # ============================================================================
  dns-server:
    build: ./dns-server
    networks:
      labnet:
        ipv4_address: 172.20.0.53
    ports:
      - "5353:5353/udp"
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(socket.AF_INET, socket.SOCK_DGRAM); s.settimeout(1); s.close()"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # SSH-SERVER - OpenSSH server with a predefined user
  # User: labuser / Password: labpass
  # ============================================================================
  ssh-server:
    build: ./ssh-server
    networks:
      labnet:
        ipv4_address: 172.20.0.22
    ports:
      - "2222:22"
    volumes:
      - ssh_data:/home/labuser/storage
    healthcheck:
      test: ["CMD", "pgrep", "sshd"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # SSH-CLIENT - Container with Paramiko for SSH automation
  # ============================================================================
  ssh-client:
    build: ./ssh-client
    networks:
      labnet:
        ipv4_address: 172.20.0.100
    depends_on:
      ssh-server:
        condition: service_healthy
    stdin_open: true
    tty: true
    volumes:
      - ./ssh-client:/app:ro

  # ============================================================================
  # FTP-SERVER - pyftpdlib on port 2121
  # User: labftp / Password: labftp
  # ============================================================================
  ftp-server:
    build: ./ftp-server
    networks:
      labnet:
        ipv4_address: 172.20.0.21
    ports:
      - "2121:2121"
      - "30000-30009:30000-30009"
    volumes:
      - ftp_data:/home/ftp
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.settimeout(2); s.connect(('localhost',2121)); s.close()"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # DEBUG - Toolbox container with dig, curl, ssh, lftp, tcpdump and nmap
  # ============================================================================
  debug:
    build: ./debug
    networks:
      labnet:
        ipv4_address: 172.20.0.200
    depends_on:
      - web
      - dns-server
      - ssh-server
      - ftp-server
    stdin_open: true
    tty: true
    # Keep the debug container running in detached mode so that students can
    # exec into it at any time (for example `make debug-shell`).
    command: ["sh", "-lc", "tail -f /dev/null"]
    cap_add:
      - NET_ADMIN
      - NET_RAW

    # Keep the container alive in detached mode.
    # Use: docker compose exec -it debug sh -l
    command: ["sh", "-lc", "tail -f /dev/null"]
