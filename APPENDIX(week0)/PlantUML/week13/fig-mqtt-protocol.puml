@startuml fig-mqtt-protocol
'A4 Portrait
skinparam backgroundColor white
skinparam defaultFontName Arial
skinparam defaultFontSize 11
skinparam shadowing false

title MQTT Protocol Flow\nMessage Queuing Telemetry Transport

participant "Sensor\n(Publisher)" as PUB
participant "Broker\nPort 1883/8883" as BROKER
participant "Dashboard\n(Subscriber)" as SUB

== Connection ==

PUB -> BROKER : CONNECT\n(ClientId, KeepAlive)
BROKER --> PUB : CONNACK (Accepted)

SUB -> BROKER : CONNECT
BROKER --> SUB : CONNACK

== Subscribe ==

SUB -> BROKER : SUBSCRIBE\nTopic: home/+/temperature\nQoS: 1
BROKER --> SUB : SUBACK

note right of BROKER
    Topic Wildcards:
    + = single level
    # = multi level
end note

== Publish (QoS 1) ==

PUB -> BROKER : PUBLISH\nTopic: home/living/temperature\nPayload: {"temp": 22.5}
BROKER --> PUB : PUBACK

BROKER -> SUB : PUBLISH\n(forwarded)
SUB --> BROKER : PUBACK

note over PUB, SUB
    QoS Levels:
    0 - At most once (fire and forget)
    1 - At least once (acknowledged)
    2 - Exactly once (4-way handshake)
end note

