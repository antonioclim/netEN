# =============================================================================
# Docker Compose for Starterkit S9 - Multi-Client Testing
# =============================================================================
# 
# Usage:
#   docker-compose up -d      # Start the stack
#   docker-compose logs -f    # View logs
#   docker-compose down       # Stop and clean up
#
# Architecture:
#   ┌─────────────────┐
#   │   ftp-server    │  Port 2121 (FTP)
#   │   (pyftpdlib)   │  Porturi 60000-60100 (passive)
#   └────────┬────────┘
#            │
#     ┌──────┴──────┐
#     │             │
# ┌───┴───┐   ┌───┴───┐
# │client1│   │client2│
# └───────┘   └───────┘
#
# =============================================================================

version: '3.8'

services:
  # Server FTP (pyftpdlib)
  ftp-server:
    image: python:3.11-slim
    container_name: s9_ftp_server
    working_dir: /app
    volumes:
      - ./server-files:/app/server-files
      - ../python/exercises:/app/exercises:ro
    ports:
      - "2121:2121"
      - "60000-60010:60000-60010"
    environment:
      - FTP_USER=test
      - FTP_PASS=12345
    command: >
      bash -c "
        pip install -q pyftpdlib &&
        python exercises/ftp_demo_server.py 
          --host 0.0.0.0 
          --port 2121 
          --root /app/server-files
          --user test 
          --password 12345
          --passive-ports 60000-60010
      "
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.socket(); s.connect(('127.0.0.1', 2121)); s.close()"]
      interval: 5s
      timeout: 3s
      retries: 3
    networks:
      - s9_network

  # Client 1
  client1:
    image: python:3.11-slim
    container_name: s9_client1
    working_dir: /app
    volumes:
      - ./client1-files:/app/client-files
      - ../python/exercises:/app/exercises:ro
    depends_on:
      ftp-server:
        condition: service_healthy
    environment:
      - FTP_HOST=ftp-server
      - FTP_PORT=2121
    command: >
      bash -c "
        sleep 2 &&
        python exercises/ftp_demo_client.py 
          --host ftp-server 
          --port 2121 
          --user test 
          --password 12345 
          --local-dir /app/client-files
          list
      "
    networks:
      - s9_network

  # Client 2
  client2:
    image: python:3.11-slim
    container_name: s9_client2
    working_dir: /app
    volumes:
      - ./client2-files:/app/client-files
      - ../python/exercises:/app/exercises:ro
    depends_on:
      ftp-server:
        condition: service_healthy
    environment:
      - FTP_HOST=ftp-server
      - FTP_PORT=2121
    command: >
      bash -c "
        sleep 3 &&
        python exercises/ftp_demo_client.py 
          --host ftp-server 
          --port 2121 
          --user test 
          --password 12345 
          --local-dir /app/client-files
          get hello.txt
      "
    networks:
      - s9_network

networks:
  s9_network:
    driver: bridge

# =============================================================================
# Revolvix&Hypotheticalandrei
# =============================================================================
